!function(){var e=function(){return this.init.apply(this,arguments)};e.prototype={init:function(){if(arguments[0].tagName&&1===arguments[0].nodeType?(this.element=arguments[0],this.setConfig(arguments[1]||{})):this.setConfig(arguments[0]),this.file=this.options.file||this.element&&this.element.querySelector("input[type=file]"),this.url=this.options.url||this.element&&this.element.action,this.max=this.options.maximum,this.size=this.options.size,this.type=this.options.type,this.cache={},!this.file)throw new Error("file does not exist!");if(!this.url)throw new Error("url cannot be empty!");if("undefined"==typeof FileReader)throw new Error("browser does not support FileReader!");this.max>1&&this.options.isMultiple?this.file.setAttribute("multiple",!0):this.file.removeAttribute("multiple"),this.bindEvent()},verify:function(e){var t=this.options.message,i=new RegExp("\\b"+this.type+"\\b");return e.size>this.size?t.size:i.test(e.type)===!1?t.type:this.options.isAllowSame||1!==this.cache[e.lastModifiedDate-0]?(this.cache[e.lastModifiedDate-0]=1,null):t.same},getUploadNum:function(){var e,t=0;for(e in this.cache)this.cache[e]&&t++;return t},bindEvent:function(){function e(){var e=this.files;if(e.length>t.max||t.getUploadNum()>=t.max)i.error(e,n.maximum);else for(var s=0;s<e.length;s++){var a=e[s],r=t.verify(a),l=new FileReader;if(r)i.error(a,r);else switch(i.rendAsType.toLowerCase()){case"string":l.readAsBinaryString(e[s]);break;case"text":l.readAsText(e[s]);break;default:l.readAsDataURL(e[s])}for(var d=0;d<o.length;d++)l.addEventListener(o[d],i[o[d]],!1);!function(e){l.addEventListener("error",function(t){i.error(e,r||n.other)},!1),l.addEventListener("load",function(n){t.ajaxUpload(e),i.load(n,e)})}(a)}}var t=this,i=t.options,n=i.message,o=["abort","loadstart","progress","loadend"];i.dropElement&&t.bindDropEvent(e),t.on(t.file,"change",function(){e.call(this),t.options.isAllowSame&&(this.dataValue=this.value,this.value="")})},bindDropEvent:function(e){var t=this.options;this.on(document,"dragenter",t.dragenter),this.on(document,"dragleave",t.dragleave),this.on(t.dropElement,"dragover",function(e){e.preventDefault(),t.dragover.call(this,e)}),this.on(t.dropElement,"drop",function(i){i.preventDefault(),i.stopPropagation(),e.call(i.dataTransfer),t.drop.call(this,i)})},ajaxUpload:function(e){var t=this,i=new XMLHttpRequest,n=t.element?new FormData(t.element):new FormData;i.lastModified=e.lastModified,i.onreadystatechange=function(){var e=this.responseText;4==this.readyState&&(this.status<300&&this.status>=200?t.options.uploadSuccess.call(this,e):(t.cache[this.lastModified]=null,t.options.uploadFailed.call(this))),this.once||(this.once=!0,t.options.uploadComplete())},n.append(t.options.uploadName||t.file.name,e),i.open("POST",t.url,!0),i.send(n)},on:function(e,t,i){return e.addEventListener(t,i,!1)},setConfig:function(e){for(var t,i={file:"",type:"image",maximum:5,size:2097152,rendAsType:"url",uploadName:"",url:"",message:{type:"类型不对!",size:"文件太大",maximum:"上传文件数量太多!",same:"不能上传相同的文件!",other:"其它网络错误!"},isMultiple:!0,isAllowSame:!1,dropElement:null,dragenter:function(){},dragleave:function(){},dragover:function(){},drop:function(){},uploadSuccess:function(){},uploadFailed:function(){},uploadComplete:function(){}},n=["abort","error","loadstart","progress","load","loadend"],o=0,s=n.length;s>o;o++)i[n[o]]=function(){};for(t in e)i.hasOwnProperty(t)&&(i[t]=e[t]);this.options=i}},window.mbUploadify=e}();