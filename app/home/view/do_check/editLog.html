{extend name="common/base" /}
{block  name="oNav"}
    {foreach name="res" item="vo" }
        {switch name="vo.id"}
            {case value="1"}
                <li f_id="{$vo.id}">
                    <a href="#">
                        <i class="icon-edit"></i>
                        <span class="menu-text"> {$vo.name} </span>
                    </a>

                </li>
            {/case}
            {case value="2"}
                <li f_id="{$vo.id}">
                    <a href="#" >
                        <i class=" icon-barcode"></i>
                        <span class="menu-text">  {$vo.name} </span>
                    </a>
                </li>
            {/case}
            {case value="3"}
                <li f_id="{$vo.id}">
                    <a href="#">
                        <i class=" icon-credit-card"></i>
                        <span class="menu-text">  {$vo.name} </span>
                    </a>
                </li>
            {/case}
            {case value="4"}
            <li f_id="{$vo.id}">
                <a href="#">
                    <i class="icon-cogs"></i>
                    <span class="menu-text">  {$vo.name} </span>
                </a>
            </li>
            {/case}
            {case value="5"}
                <li f_id="{$vo.id}">
                    <a href="#" >
                        <i class="icon-desktop"></i>
                        <span class="menu-text">  {$vo.name} </span>
                    </a>
                </li>
            {/case}
            {case value="6"}
                <li f_id="{$vo.id}">
                    <a href="#" >
                        <i class="icon-book"></i>
                        <span class="menu-text">  {$vo.name} </span>
                    </a>
                </li>
            {/case}
            {default /}default
        {/switch}
    {/foreach}
{/block}
{block name="txbody"}
<!-- 字体图标 -->
<link rel="stylesheet" type="text/css" href="__MOBILE__/css/ionicons.min.css" />
<!-- end 字体图标 -->

<!-- layer -->

<link rel="stylesheet" type="text/css" href="__PC__/layui/css/layui.css" />
<script type="text/javascript" src="__PC__/layui/lay/dest/layui.all.js"></script>
<!-- <script type="text/javascript" src="__PC__/layui/layui.js"></script> -->
<!-- <script type="text/javascript">
    layui.config({
        base: '__PC__/layui/lay/modules/' // 模块目录
    }).use('laypage'); // 加载入口
</script> -->
<style type="text/css">
/*#layui-laypage-0 {
	float: right;
	width: auto;
}*/
.row {
	margin: 0;
}
.layui-laypage-curr, .layui-laypage-em {
	background-color: #6faed9!important;
}
</style>
<style type="text/css">
    #problem{
        width: 100%;
        height: auto;
    }
    #problem li {
        float: left;
        width: 40%;
        line-height: 40px;
        position: relative;
    }
    .problem {
        float: left;
    }
    .answer {
        float: right;
        width: 124px;
    }
    .answer label {
        width: 60px;
        text-align: right;
        cursor: pointer;
    }
    .answer i, .all-yes-btn i {
        font-size: 22px;
        color: #17a3ff; /* 图标颜色 */
        cursor: pointer;
    }
    .yes {
        /*margin-right: 4%;*/
    }
    .answer-option {
        display: none;
    }
    .edit {
        position: absolute;
        right: -24px;
        top: 0;
    }
    .idea {
        /* 填写处理意见 */
        width: 100%;
        height: 60px;
        border: 1px solid #0096f7;
        padding-left: 4%;
        display: none;
    }
    /*图片预览*/

/*.view-img {
    position: relative;
    float: left;
    margin-right: 0.1875rem;
    margin-bottom: 0.1875rem;
    width: 30%;
    height: auto;
    box-sizing: border-box;
}*/

.view-img img {
    width: 100%;
    height: 100%;
}

/*#get-view {
    padding-left: 6.9999%;
}*/

/*.del-img {
    position: absolute;
    right: -0.1875rem;
    top: -0.1875rem;
    display: block;
    width: 0.375rem;
    height: 0.375rem;
    border-radius: 50%;
    color: #f7333d;
    text-align: center;
    text-decoration: none;
    font-size: 0.4rem;
    overflow: hidden;
    background-clip: padding-box;
    background: #fff;
}*/


/*end 图片预览*/
</style>
<!-- end layer -->
<table style="width: 100%; height: 86px;">
    <tr style="line-height: 42px;">
        <td colspan="2">详细地址：{$roomInfo.cityName}{$roomInfo.areaName}{$roomInfo.xqName}{$roomInfo.dong}{$roomInfo.unit}单元{$roomInfo.room}</td>
        <td style="width: 30%;">检查人：{$roomInfo.checker}</td>
        <td style="width: 30%;">检查时间：{$roomInfo.checktime|date="Y-m-d H:i:s", ###}</td>
    </tr>
    <tr style="line-height: 42px;">
        <td style="width: 25%;">姓名：{$roomInfo.cstname}</td>
        <td style="width: 25%;">电话：{$roomInfo.telphone}</td>
        <td style="width: 25%;">用户编号：{$roomInfo.cstcode}</td>
        <td style="width: 25%;">表底数：{$roomInfo.basenumber}</td>
    </tr>
</table>
<div style="width: 100%; height: 1px; background-color: #ccc;"></div>
<div class="col-sm-12" style="line-height: 70px; height: 70px;">
    <div class="col-sm-8">
        <label style="margin-right: 4%;">
            <span>气表类型：</span>
            <select style="border: 1px solid #307ecc; border-radius: 6px;" name="type">
                {volist name="type" id="vo"}
                    <option {eq name="$roomInfo['type']" value="$vo.id"}selected{/eq} value="{$vo.id}">{$vo.name}</option>
                {/volist}
            </select>
        </label>
        <label style="margin-right: 4%;">
            <span>品牌：</span>
            <select style="border: 1px solid #307ecc; border-radius: 6px;" name="brand">
                {volist name="brand" id="vo"}
                    <option {eq name="$roomInfo['brand']" value="$vo.id"}selected{/eq} value="{$vo.id}">{$vo.name}</option>
                {/volist}
            </select>
        </label>
        <label>
            <span>进气方向：</span>
            <select style="border: 1px solid #307ecc; border-radius: 6px;" name="direction" id="path">
                <option value="上">上</option>
                <option value="下">下</option>
                <option value="左">左</option>
                <option value="右">右</option>
            </select>
        </label>
        <script type="text/javascript" src="__MOBILE__/js/jquery-1.8.3.min.js"></script>
        <script type="text/javascript">
        // 进气方向
        $('#path option').each(function(i){
             if ($(this).val() == '{$roomInfo['direction']}') {
                $(this).attr('selected', 'selected');
                return false;
             }
         });
        </script>
    </div>
</div>
<!-- 上传照片引用 -->
<!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"> -->
<link href="__PC__/fileinput/fileinput.css" media="all" rel="stylesheet" type="text/css"/>
<link href="__PC__/fileinput/theme.css" media="all" rel="stylesheet" type="text/css"/>
<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> -->
<script src="__PC__/fileinput/sortable.js" type="text/javascript"></script>
<script src="__PC__/fileinput/fileinput.js" type="text/javascript"></script>
<script src="__PC__/fileinput/zh.js" type="text/javascript"></script>
<script src="__PC__/fileinput/theme.js" type="text/javascript"></script>
<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script> -->
<!-- end 上传照片引用 -->
<!-- form表单 -->
<form action="#" method="post" class="room-info" enctype="multipart/form-data" id="goToPost">
    <div>上传照片</div>
    <!-- <input id="file-5" class="file" type="file" multiple data-preview-file-type="any" data-upload-url="#">
    <script>
    $("#file-5").fileinput({
        uploadUrl: '#', // you must set a valid URL here else you will get an error
        language: 'zh',
        allowedFileExtensions: ['jpg', 'png', 'gif', 'jpeg'],
        overwriteInitial: false,
        maxFileSize: 1000,
        maxFilesNum: 8,
        allowedFileTypes: ['image'],
        slugCallback: function (filename) {
            return filename.replace('(', '_').replace(']', '_');
        }
    });
    </script> -->
    <!-- test -->
    <!-- 引入图标库 -->
    <link rel="stylesheet" type="text/css" href="__MOBILE__/css/ionicons.min.css" />
    <!-- end 引入图标库 -->
    <link rel="stylesheet" type="text/css" href="__PC__/uploadImg/tinyImgUpload.css">
    <script type="text/javascript" src="__PC__/uploadImg/tinyImgUpload.js"></script>
    <!-- end test -->
    <div class="col-sm-12" style="border: 1px solid #17a3ff; padding: 2%;">
        <div id="get-view">
            {volist name="imgUrl" id="vo"}
                <div class="view-img">
                    <img src="{$vo.url}">
                    <div href="javascript:;" class="del-img ion-android-cancel"></div>
                </div>
            {/volist}
        </div>
        <div id="upload"></div>
        <div class="btn btn-primary go-submit" style="display: none;">开始上传</div>
    </div>
    <div id="submitIMG"></div>
    <!-- 穿透编辑图片 -->
    <script type="text/javascript">
        $('.del-img').click(function(){ // 删除已上传的图片

            // 先定义变量，否则后面无法找到$(this)
            var imgDiv = $(this).parent(); // 定位父节点，即图片盒子
            var nowImgUrl = $(this).siblings().attr('src'); // siblings找到同级元素

            // 询问框
            swal({ 
                title: '删除后无法恢复，要继续么？', 
                text: '此操作不可逆', 
                type: 'warning',
                showCancelButton: true, 
                cancelButtonText: '算了',
                confirmButtonColor: "#DD6B55",
                confirmButtonText: '继续', 
                closeOnConfirm: false
            },
            function(){
                $.get("{:url('home/do_check/deleteImg')}", {nowImgUrl: nowImgUrl}, function(data){
                    if (data == 1) {
                        // swal('图片删除成功'); 
                        swal({ 
                            title: '图片删除成功', 
                            timer: 1000, 
                            showConfirmButton: false 
                        });
                        imgDiv.remove(); // 移除图片DOM节点
                    } else {
                        sweetAlert(data, '出了一点小状况，过一会再试吧', 'error');
                    }
                }, 'json'); // 1成功 0失败
                
            });
        });
    </script>
    <!-- end 穿透编辑图片 -->


    <!-- test -->
    <script type="text/javascript">
        
        var goSubmit = document.getElementsByClassName('go-submit')[0];
        var options = {
            path: '{:url('home/do_check/doImg')}',
            onSuccess: function (res) { // 根据xhr返回状态码判断成功与否
                document.getElementsByClassName('go-submit')[0].innerHTML = '开始上传';
                // swal('图片已成功上传');
                swal({ 
                    title: '图片已成功上传', 
                    timer: 1000, 
                    showConfirmButton: false 
                });
                let dataObj = eval(res); // json转对象
                for (var i = 0; i < dataObj.length; i++) { // 原生最快
                    document.getElementById('submitIMG').innerHTML += '<input type="hidden" name="image[]" value="' + dataObj[i].url + '" />';
                }
                document.getElementsByClassName('go-submit')[0].style.display = 'none';
                var removeBtn = document.getElementsByClassName('img-remove');
                for (var i = 0; i < removeBtn.length; i++) { // 隐藏所有红x
                    removeBtn[i].style.display = 'none';
                }
                document.getElementsByClassName('select-btn')[0].style.display = 'none';
            },
            onFailure: function (res) {
                // console.log(res);
                // goSubmit.innerHTML = '开始上传';
                sweetAlert('哎呀...', '出了一点小状况，过一会再试吧', 'error');
            }
        }
        var upload = tinyImgUpload('#upload', options);
        // document.getElementById('upload').onclick = function(){
        //     goSubmit.style.display = 'block';
        // }
        goSubmit.onclick = function (e) {
            var imgNum = $('#img-container img').size(); // 图片数量
            var viewImgNum = $('#get-view img').size(); // 已上传图片数量
            var allImgNum = imgNum + viewImgNum; // 总图片数量
            if (imgNum === 0) {
                sweetAlert('哎呀...', '您还没有选择图片', 'error');
            } else if (allImgNum > 8) {
                sweetAlert('哎呀...', '图片不能超过8张', 'error');
            } else {
                document.getElementsByClassName('go-submit')[0].innerHTML = '正在上传';
                upload();
            }
            return false; // 阻止触发整张表单的post事件
        }
        document.getElementsByClassName('select-btn')[0].onclick = function(){
            goSubmit.style.display = 'block';
        }

    </script>
    <!-- end test -->



    
    <div class="col-sm-12">
        <ul id="problem">
        {volist name="toGetPro" id="vo" mod="1"}
            <li {php}if ($i%2 == 1):{/php}style="margin-right: 19%;"{php}endif;{/php}>
                <div class="problem">
                    {$vo['question']}：
                </div>
                <!-- 隐藏提交问题 -->
                <input type="hidden" name="{$vo.id}[question]" value="{$vo['question']}" />
                <div class="answer">
                    <label class="yes{$vo.id}">
                        <span>{$vo['yes']}<i {eq name="$vo['answer']" value="1"}class="ion-ios-checkmark-outline"{else/}class="ion-ios-circle-outline"{/eq} data="1"></i></span>
                        <input type="radio" name="{$vo.id}[answer]" value="1" class="answer-option" {eq name="$vo['answer']" value="1"}checked="checked"{/eq} />
                    </label>
                    <label class="no{$vo.id}">
                        <span>{$vo['no']}<i {eq name="$vo['answer']" value="0"}class="ion-ios-checkmark-outline"{else/}class="ion-ios-circle-outline"{/eq} data="0"></i></span>
                        <input type="radio" name="{$vo.id}[answer]" value="0" class="answer-option" {eq name="$vo['answer']" value="0"}checked="checked"{/eq} />
                    </label>
                    <i class="ion-ios-compose-outline edit" id="edit{$vo.id}"></i>
                </div>
                <div class="clear"></div>
                <input type="text" name="{$vo.id}[remark]" value="{$vo['remark']}" class="idea" id="idea{$vo.id}" placeholder="请填写处理意见" />
            </li>
            <script type="text/javascript">
                // 编辑
                $('#edit{$vo.id}').click(function(){
                    $('#idea{$vo.id}').fadeToggle('fast'); // 淡入淡出
                }); 

                // 选答案
                $('.yes{$vo.id}').click(function(){
                    $('.yes{$vo.id} i').attr('class', 'ion-ios-checkmark-outline'); // 打勾
                    $('.no{$vo.id} i').attr('class', 'ion-ios-circle-outline'); // 去钩
                });
                $('.no{$vo.id}').click(function(){
                    $('.no{$vo.id} i').attr('class', 'ion-ios-checkmark-outline');
                    $('.yes{$vo.id} i').attr('class', 'ion-ios-circle-outline');
                    $('#idea{$vo.id}').fadeTo('fast', 1); // 自动打开编辑框
                    $('.all-yes-btn i').attr('class', 'ion-ios-circle-outline'); // 去掉全部无问题的钩
                });
            </script>
        {/volist}
        </ul>
        <!-- 隐藏提交cstcode，用于判断是否更新操作 -->
        <input type="hidden" name="cstcode" value="{$roomInfo['cstcode']}" />
    </div>
    <div class="col-sm-12 center" style="line-height: 60px;">
        <label class="all-yes-btn" style="display: block; width: 600px; margin: 0 auto;">全部无问题<i class="ion-ios-circle-outline"></i></label>
    </div>
    <script type="text/javascript">
        // 全部无问题
        $('.all-yes-btn').click(function() {

            // 全无问题Btn
            // if ($('.all-yes-btn i').attr('class') == 'ion-ios-circle-outline') {
                $('.all-yes-btn i').attr('class', 'ion-ios-checkmark-outline');
            // } else {
                // $('.all-yes-btn i').attr('class', 'ion-ios-circle-outline');
            // }

            $('.idea').hide(); // 隐藏意见框

            // 所有通过项样式
            $('.answer label i').each(function(i){
                if($(this).attr('data') == 1){ // 通过选项
                    $(this).attr('class', 'ion-ios-checkmark-outline');
                } else { // 不通过选项
                    $(this).attr('class', 'ion-ios-circle-outline');
                }
             });

            // 选中所有通过项
            $('.answer .answer-option').each(function(i){
                if ($(this).val() == 1) { // 1通过
                    $(this).attr('checked', 'checked');
                } else {
                    $(this).removeAttr('checked');
                }
            });
        });
    </script>
    <div class="col-sm-12" style="text-align: center;">
        <button class="btn btn-primary" id="doPost">确定修改</button>
    </div>
    <script src="__MOBILE__/sweetalert/sweetalert.min.js"></script>
    <link rel="stylesheet" type="text/css" href="__MOBILE__/sweetalert/sweetalert.css">
    <script type="text/javascript">
        $('#doPost').click(function(){ // 点击提交
            $('#doPost').html('正在提交');
            $.post("{:url('home/do_check/doAddLog')}", $('#goToPost').serialize(), function(data){ // 异步post，方便加tips
                if (data) {
                    swal('恭喜，修改成功', '请等待复审结果', 'success');
                    $('#doPost').html('确定修改');
                    setTimeout(function() {
                        window.location.href = "{:url('home/do_check/wait')}";
                    }, 1000)
                } else {
                    sweetAlert('哎呀...', '出了一点小状况，过一会再试吧', 'error');
                    $('#doPost').html('确定修改');
                }
            }, 'json');
            return false; // 阻止事件穿透
        });
    </script>
</form>
{/block}